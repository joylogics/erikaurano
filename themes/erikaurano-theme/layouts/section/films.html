{{ define "main" }}
  <div id="body-content">
    <!-- Controls for filtering films -->
    <div class="films-controls">
      <div class="role-filters">
        <button class="filter-btn active" data-role="all">All</button>
        <button class="filter-btn" data-role="Director">Director</button>
        <button class="filter-btn" data-role="Writer">Writer</button>
        <button class="filter-btn" data-role="Production Designer">Production Designer</button>
      </div>
    </div>

    <div class="films-grid">
      {{ range .Pages.ByWeight }}
        {{ $videoEmbed := "" }}
        {{ if .Params.link }}
          {{ if findRE "^https?://(?:www\\.)?(?:youtube\\.com/watch\\?v=|youtu\\.be/)([^&?/]+)" .Params.link }}
            {{ $youtubeId := replaceRE "^https?://(?:www\\.)?(?:youtube\\.com/watch\\?v=|youtu\\.be/)([^&?/]+).*" "$1" .Params.link }}
            {{ $videoEmbed = printf "https://www.youtube.com/embed/%s" $youtubeId }}
          {{ else if findRE "^https?://(?:www\\.)?vimeo\\.com/([0-9]+)" .Params.link }}
            {{ $vimeoId := replaceRE "^https?://(?:www\\.)?vimeo\\.com/([0-9]+).*" "$1" .Params.link }}
            {{ $videoEmbed = printf "https://player.vimeo.com/video/%s" $vimeoId }}
          {{ end }}
        {{ end }}
        <div class="film-card{{ if or .Params.playlist $videoEmbed }} has-embedded-video{{ end }}" data-roles="{{ delimit .Params.roles " " }}">
          <div class="film-preview">
            {{ if .Params.playlist }}
              <div class="video-container">
                <video poster="{{ .Params.preview }}" data-playlist="{{ .Params.playlist }}" controls></video>
              </div>
            {{ else if $videoEmbed }}
              <div class="video-container lazy-video" data-embed-url="{{ $videoEmbed }}">
                <div class="video-thumbnail">
                  {{ if .Params.preview }}
                    <img src="{{ .Params.preview }}" alt="{{ .Title }}" loading="lazy">
                  {{ else }}
                    <!-- Generate thumbnail from video ID -->
                    {{ if findRE "youtube" $videoEmbed }}
                      {{ $youtubeId := replaceRE "^https://www.youtube.com/embed/([^?]+).*" "$1" $videoEmbed }}
                      <img src="https://img.youtube.com/vi/{{ $youtubeId }}/maxresdefault.jpg" alt="{{ .Title }}" loading="lazy">
                    {{ else if findRE "vimeo" $videoEmbed }}
                      {{ $vimeoId := replaceRE "^https://player.vimeo.com/video/([^?]+).*" "$1" $videoEmbed }}
                      <img src="{{ .Params.preview | default (printf "https://vumbnail.com/%s.jpg" $vimeoId) }}" alt="{{ .Title }}" loading="lazy" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22640%22 height=%22360%22 viewBox=%220 0 640 360%22%3E%3Crect width=%22640%22 height=%22360%22 fill=%22%23000%22/%3E%3Ctext x=%22320%22 y=%22180%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23fff%22 font-size=%2220%22%3EVideo Preview%3C/text%3E%3C/svg%3E'">
                    {{ end }}
                  {{ end }}
                  <div class="play-button">
                    <svg width="68" height="48" viewBox="0 0 68 48" fill="none">
                      <path d="M66.52,7.74c-0.78-2.93-2.49-5.41-5.42-6.19C55.79,.13,34,0,34,0S12.21,.13,6.9,1.55 C3.97,2.33,2.27,4.81,1.48,7.74C0.06,13.05,0,24,0,24s0.06,10.95,1.48,16.26c0.78,2.93,2.49,5.41,5.42,6.19 C12.21,47.87,34,48,34,48s21.79-0.13,27.1-1.55c2.93-0.78,4.64-3.26,5.42-6.19C67.94,34.95,68,24,68,24S67.94,13.05,66.52,7.74z" fill="#f00"></path>
                      <path d="M 45,24 27,14 27,34" fill="#fff"></path>
                    </svg>
                  </div>
                </div>
              </div>
            {{ else if .Params.preview }}
              <img src="{{ .Params.preview }}" alt="{{ .Title }}" loading="lazy">
            {{ end }}
            <div class="film-overlay">
              {{ if or .Params.preview .Params.link }}
                <a href="{{ .Permalink }}" class="film-overlay-link">
                  <span class="view-details">View Details</span>
                </a>
              {{ else }}
                <div class="film-overlay-link">
                  <span class="view-details">Coming Soon</span>
                </div>
              {{ end }}
            </div>
          </div>
          {{ if or .Params.preview .Params.link }}
            <a href="{{ .Permalink }}" class="film-info-link">
              <div class="film-info">
                <h3>{{ .Title }}</h3>
                <div class="film-meta">
                  <span class="film-year">{{ .Params.year }}</span>
                  <div class="film-roles">
                    {{ range .Params.roles }}
                      <span class="role-badge">{{ . }}</span>
                    {{ end }}
                  </div>
                </div>
                <p class="film-description">{{ .Description }}</p>
              </div>
            </a>
          {{ else }}
            <div class="film-info-link">
              <div class="film-info">
                <h3>{{ .Title }}</h3>
                <div class="film-meta">
                  <span class="film-year">{{ .Params.year }}</span>
                  <div class="film-roles">
                    {{ range .Params.roles }}
                      <span class="role-badge">{{ . }}</span>
                    {{ end }}
                  </div>
                </div>
                <p class="film-description">{{ .Description }}</p>
              </div>
            </div>
          {{ end }}
        </div>
      {{ end }}
    </div>
  </div>


{{ end }}
