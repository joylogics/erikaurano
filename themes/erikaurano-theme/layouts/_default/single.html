{{ define "main" }}
  <div id="body-content">

    <div class="film-single">
      <div class="film-header">
        <h1>{{ .Title }}</h1>
      </div>

      <div class="film-player">
        {{ $videoEmbed := "" }}
        {{ if .Params.link }}
          {{ if findRE "^https?://(?:www\\.)?(?:youtube\\.com/watch\\?v=|youtu\\.be/)([^&?/]+)" .Params.link }}
            {{ $youtubeId := replaceRE "^https?://(?:www\\.)?(?:youtube\\.com/watch\\?v=|youtu\\.be/)([^&?/]+).*" "$1" .Params.link }}
            {{ $videoEmbed = printf "https://www.youtube.com/embed/%s" $youtubeId }}
          {{ else if findRE "^https?://(?:www\\.)?vimeo\\.com/([0-9]+)" .Params.link }}
            {{ $vimeoId := replaceRE "^https?://(?:www\\.)?vimeo\\.com/([0-9]+).*" "$1" .Params.link }}
            {{ $videoEmbed = printf "https://player.vimeo.com/video/%s" $vimeoId }}
          {{ end }}
        {{ end }}

        {{ if .Params.playlist }}
          <div class="video-container-single lazy-hls" data-playlist="{{ .Params.playlist }}" data-poster="{{ .Params.preview }}">
            <div class="video-thumbnail">
              <img src="{{ .Params.preview }}" alt="{{ .Title }}" loading="lazy">
              <div class="play-button hls-play-button">
                <svg width="80" height="80" viewBox="0 0 80 80" fill="none">
                  <circle cx="40" cy="40" r="35" fill="rgba(255,255,255,0.9)" stroke="rgba(0,0,0,0.2)" stroke-width="2"/>
                  <path d="M32 25 L55 40 L32 55 Z" fill="#333"/>
                </svg>
              </div>
            </div>
          </div>
        {{ else if $videoEmbed }}
          <div class="video-container-single lazy-video" data-embed-url="{{ $videoEmbed }}">
            <div class="video-thumbnail">
              {{ if .Params.preview }}
                <img src="{{ .Params.preview }}" alt="{{ .Title }}" loading="lazy">
              {{ else }}
                <!-- Generate thumbnail from video ID -->
                {{ if findRE "youtube" $videoEmbed }}
                  {{ $youtubeId := replaceRE "^https://www.youtube.com/embed/([^?]+).*" "$1" $videoEmbed }}
                  <img src="https://img.youtube.com/vi/{{ $youtubeId }}/maxresdefault.jpg" alt="{{ .Title }}" loading="lazy">
                {{ else if findRE "vimeo" $videoEmbed }}
                  {{ $vimeoId := replaceRE "^https://player.vimeo.com/video/([^?]+).*" "$1" $videoEmbed }}
                  <img src="{{ .Params.preview | default (printf "https://vumbnail.com/%s.jpg" $vimeoId) }}" alt="{{ .Title }}" loading="lazy" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22640%22 height=%22360%22 viewBox=%220 0 640 360%22%3E%3Crect width=%22640%22 height=%22360%22 fill=%22%23000%22/%3E%3Ctext x=%22320%22 y=%22180%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23fff%22 font-size=%2220%22%3EVideo Preview%3C/text%3E%3C/svg%3E'">
                {{ end }}
              {{ end }}
              <div class="play-button">
                <svg width="68" height="48" viewBox="0 0 68 48" fill="none">
                  <path d="M66.52,7.74c-0.78-2.93-2.49-5.41-5.42-6.19C55.79,.13,34,0,34,0S12.21,.13,6.9,1.55 C3.97,2.33,2.27,4.81,1.48,7.74C0.06,13.05,0,24,0,24s0.06,10.95,1.48,16.26c0.78,2.93,2.49,5.41,5.42,6.19 C12.21,47.87,34,48,34,48s21.79-0.13,27.1-1.55c2.93-0.78,4.64-3.26,5.42-6.19C67.94,34.95,68,24,68,24S67.94,13.05,66.52,7.74z" fill="#f00"></path>
                  <path d="M 45,24 27,14 27,34" fill="#fff"></path>
                </svg>
              </div>
            </div>
          </div>
        {{ else if .Params.preview }}
          <div class="film-image">
            <img src="{{ .Params.preview }}" alt="{{ .Title }}">
          </div>
        {{ end }}
      </div>

      <div class="film-content">
        <div class="film-meta">
          <span class="film-year">{{ .Params.year }}</span>
        </div>

        <div class="film-description">
          {{ .Content }}
          
          {{ if and .Params.link (not $videoEmbed) }}
            <div class="film-links">
              <a href="{{ .Params.link }}" target="_blank" class="watch-link-single">
                Watch {{ if eq .Params.type "music-video" }}on YouTube{{ else }}Film{{ end }}
              </a>
            </div>
          {{ end }}
        </div>
      </div>

      {{ $stillsPath := printf "/films/%s/stills/" .File.BaseFileName }}
      {{ $stillsImages := slice }}
      {{ $stillsDir := printf "static/films/%s/stills" .File.BaseFileName }}
      {{ if fileExists $stillsDir }}
        {{ range (readDir $stillsDir) }}
          {{ if or (strings.HasSuffix .Name ".jpg") (strings.HasSuffix .Name ".jpeg") (strings.HasSuffix .Name ".png") (strings.HasSuffix .Name ".webp") }}
            {{ $stillsImages = $stillsImages | append (printf "%s%s" $stillsPath .Name) }}
          {{ end }}
        {{ end }}
      {{ end }}

      {{ if $stillsImages }}
        <div class="location-gallery">
          <h2>Stills</h2>
          <div class="gallery-grid">
            {{ range $index, $image := $stillsImages }}
              <div class="gallery-item">
                <img src="{{ $image }}" alt="Still from film" loading="lazy" class="gallery-thumbnail" data-index="{{ $index }}">
              </div>
            {{ end }}
          </div>
        </div>

        <!-- Lightbox Modal -->
        <div id="lightbox" class="lightbox">
          <div class="lightbox-content">
            <span class="lightbox-close">&times;</span>
            <img id="lightbox-image" src="" alt="Still from film">
            <div class="lightbox-nav">
              <button id="lightbox-prev" class="lightbox-nav-btn">&#8249;</button>
              <button id="lightbox-next" class="lightbox-nav-btn">&#8250;</button>
            </div>
            <div class="lightbox-counter">
              <span id="lightbox-current">1</span> / <span id="lightbox-total">{{ len $stillsImages }}</span>
            </div>
          </div>
        </div>
      {{ end }}


    </div>
  </div>
{{ end }} 
