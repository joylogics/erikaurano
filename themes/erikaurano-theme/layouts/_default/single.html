{{ define "main" }}
  <div id="body-content">
    <div class="film-single">
      <div class="film-header">
        <h1>{{ .Title }}</h1>
        <div class="film-meta">
          <span class="film-year">{{ .Params.year }}</span>
          <div class="film-roles">
            {{ range .Params.roles }}
              <span class="role-badge">{{ . }}</span>
            {{ end }}
          </div>
        </div>
      </div>

      <div class="film-content">
        <div class="film-player">
          {{ $videoEmbed := "" }}
          {{ if .Params.link }}
            {{ if findRE "^https?://(?:www\\.)?(?:youtube\\.com/watch\\?v=|youtu\\.be/)([^&?/]+)" .Params.link }}
              {{ $youtubeId := replaceRE "^https?://(?:www\\.)?(?:youtube\\.com/watch\\?v=|youtu\\.be/)([^&?/]+).*" "$1" .Params.link }}
              {{ $videoEmbed = printf "https://www.youtube.com/embed/%s" $youtubeId }}
            {{ else if findRE "^https?://(?:www\\.)?vimeo\\.com/([0-9]+)" .Params.link }}
              {{ $vimeoId := replaceRE "^https?://(?:www\\.)?vimeo\\.com/([0-9]+).*" "$1" .Params.link }}
              {{ $videoEmbed = printf "https://player.vimeo.com/video/%s" $vimeoId }}
            {{ end }}
          {{ end }}

          {{ if .Params.playlist }}
            <div class="video-container-single">
              <video poster="{{ .Params.preview }}" data-playlist="{{ .Params.playlist }}" controls></video>
            </div>
          {{ else if $videoEmbed }}
            <div class="video-container-single">
              <iframe 
                src="{{ $videoEmbed }}" 
                frameborder="0" 
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                allowfullscreen
                loading="lazy"
                title="{{ .Title }}"
              ></iframe>
            </div>
          {{ else if .Params.preview }}
            <div class="film-image">
              <img src="{{ .Params.preview }}" alt="{{ .Title }}">
            </div>
          {{ end }}
        </div>

        <div class="film-description">
          {{ .Content }}
          
          {{ if and .Params.link (not $videoEmbed) }}
            <div class="film-links">
              <a href="{{ .Params.link }}" target="_blank" class="watch-link-single">
                Watch {{ if eq .Params.type "music-video" }}on YouTube{{ else }}Film{{ end }}
              </a>
            </div>
          {{ end }}
        </div>
      </div>

      {{ $stillsPath := printf "/films/%s/stills/" .File.BaseFileName }}
      {{ $stillsImages := slice }}
      {{ $stillsDir := printf "static/films/%s/stills" .File.BaseFileName }}
      {{ if fileExists $stillsDir }}
        {{ range (readDir $stillsDir) }}
          {{ if or (strings.HasSuffix .Name ".jpg") (strings.HasSuffix .Name ".jpeg") (strings.HasSuffix .Name ".png") (strings.HasSuffix .Name ".webp") }}
            {{ $stillsImages = $stillsImages | append (printf "%s%s" $stillsPath .Name) }}
          {{ end }}
        {{ end }}
      {{ end }}

      {{ if $stillsImages }}
        <div class="location-gallery">
          <h2>Stills</h2>
          <div class="gallery-grid">
            {{ range $index, $image := $stillsImages }}
              <div class="gallery-item">
                <img src="{{ $image }}" alt="Still from film" loading="lazy" class="gallery-thumbnail" data-index="{{ $index }}">
              </div>
            {{ end }}
          </div>
        </div>

        <!-- Lightbox Modal -->
        <div id="lightbox" class="lightbox">
          <div class="lightbox-content">
            <span class="lightbox-close">&times;</span>
            <img id="lightbox-image" src="" alt="Still from film">
            <div class="lightbox-nav">
              <button id="lightbox-prev" class="lightbox-nav-btn">&#8249;</button>
              <button id="lightbox-next" class="lightbox-nav-btn">&#8250;</button>
            </div>
            <div class="lightbox-counter">
              <span id="lightbox-current">1</span> / <span id="lightbox-total">{{ len $stillsImages }}</span>
            </div>
          </div>
        </div>
      {{ end }}

      <div class="film-navigation">
        <a href="/films/" class="back-to-films">‚Üê Back to Films</a>
      </div>
    </div>
  </div>
{{ end }} 
